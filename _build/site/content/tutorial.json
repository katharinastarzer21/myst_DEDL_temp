{"version":2,"kind":"Notebook","sha256":"f1c39c9b4aad4e75f67669a61d8ee38af4a62ccd51574c270d0c4ec75fd12a69","slug":"tutorial","location":"/HOOK/Tutorial.ipynb","dependencies":[],"frontmatter":{"title":"DEDL - Hook Tutorial - Data Harvest (data-harvest)","content_includes_title":true,"kernelspec":{"name":"python3","display_name":".venv","language":"python"},"numbering":{"title":{"offset":2}},"thumbnail":"/b27bd30f978ddf0848f3ea0942070886.jpeg","exports":[{"format":"ipynb","filename":"Tutorial.ipynb","url":"/Tutorial-98049523dd2e93d981f948d22c5a674e.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"image","url":"/b27bd30f978ddf0848f3ea0942070886.jpeg","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"B5M0QI2gv3","urlSource":"https://github.com/destination-earth/DestinE-DataLake-Lab/blob/main/img/DestinE-banner.jpg?raw=true"}],"visibility":"show","key":"rHxSSI9khZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Author","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WJw0r5SQlv"}],"key":"GZ8YMyPx8W"},{"type":"text","value":": EUMETSAT ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oufLzyaEd3"},{"type":"break","key":"hftl601G7W"},{"type":"text","value":"\n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RpL1JoQlpA"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Copyright","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"F4NIrGojRA"}],"key":"HzZoWCElZf"},{"type":"text","value":": 2024 EUMETSAT ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Z9irJX4Tpv"},{"type":"break","key":"KRHEVG0HTB"},{"type":"text","value":"\n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UqGXZcXL5c"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Licence","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"S8QSvHAkM5"}],"key":"LOIdwCeF4v"},{"type":"text","value":": MIT ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MbeW2xqo7y"},{"type":"break","key":"HmfqdZJRtn"}],"key":"E2fiLvEHT0"},{"type":"heading","depth":1,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"DEDL - Hook Tutorial - Data Harvest (data-harvest)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yxJo4lx0VW"}],"identifier":"dedl-hook-tutorial-data-harvest-data-harvest","label":"DEDL - Hook Tutorial - Data Harvest (data-harvest)","html_id":"dedl-hook-tutorial-data-harvest-data-harvest","implicit":true,"key":"V0nhEwZBUL"}],"key":"yVuux9fwpD"},{"type":"block","kind":"notebook-content","data":{"id":"yvO6LeZHsz2Q"},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates how to use the Hook service.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZtRbsNEIIM"}],"key":"u1HF5UHj2H"}],"identifier":"yvo6lezhsz2q","label":"yvO6LeZHsz2Q","html_id":"yvo6lezhsz2q","key":"Td3TkriGoO"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Author: EUMETSAT","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"wCtgaSVom8"}],"key":"TOxuEh8V9k"}],"visibility":"show","key":"Lja3NT2NIg"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"The detailed API and definition of each endpoint and parameters is available in the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DT6k6i8Q1N"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"OnDemand Processing API OData v1","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TvqhsCPxS8"}],"key":"fqwrQVYXD9"},{"type":"text","value":"  OpenAPI documentation found at:\n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"a7sq5q1bJI"},{"type":"link","url":"https://odp.data.destination-earth.eu/odata/docs","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"https://​odp​.data​.destination​-earth​.eu​/odata​/docs","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gJ81YRuVMy"}],"urlSource":"https://odp.data.destination-earth.eu/odata/docs","key":"E08nsOIxQ0"}],"key":"lQoBB79Xoy"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Further documentation is available at:\n","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"jbxqRzEnAr"},{"type":"link","url":"https://destine-data-lake-docs.data.destination-earth.eu/en/latest/dedl-big-data-processing-services/Hook-service/Hook-service.html","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"https://​destine​-data​-lake​-docs​.data​.destination​-earth​.eu​/en​/latest​/dedl​-big​-data​-processing​-services​/Hook​-service​/Hook​-service​.html","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"FveXn1uZel"}],"urlSource":"https://destine-data-lake-docs.data.destination-earth.eu/en/latest/dedl-big-data-processing-services/Hook-service/Hook-service.html","key":"IC6VgLaGKn"}],"key":"r9N0Ih3gmZ"}],"visibility":"show","key":"SGKJWw3a0K"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Install python package requirements and import environment variables","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aaGdee4nwu"}],"identifier":"install-python-package-requirements-and-import-environment-variables","label":"Install python package requirements and import environment variables","html_id":"install-python-package-requirements-and-import-environment-variables","implicit":true,"key":"xVTvoxPaVd"}],"key":"cax0ibnkLX"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Note: The destinelab python package (which helps with authentication) is available already if you are using Python DEDL kernel\n# Otherwise, the destinelab python package can be installed by uncommenting the following line\n\n# For the importing of environment variables using the load_dotenv(...) command \n%pip install python-dotenv\n# for example code navigating private S3 compatible storage (PRIVATE bucket storage)\n%pip install boto3\n","visibility":"show","key":"hZLPjXHZFm"},{"type":"output","id":"6fHvngCXQ1WD3ZiTdmOrf","data":[],"visibility":"show","key":"pZJtXYnxRB"}],"visibility":"show","key":"dxM4UibfYu"},{"type":"block","kind":"notebook-code","data":{"id":"oyJN4WaVsz2S","tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport json\nimport requests\nfrom dotenv import load_dotenv\nfrom getpass import getpass\nimport destinelab as destinelab\n\n# Load (optional) notebook specific environment variables from .env_tutorial\nload_dotenv(\"./.env_tutorial\", override=True)","identifier":"oyjn4wavsz2s-code","visibility":"show","enumerator":"1","html_id":"oyjn4wavsz2s-code","key":"oWDXnK6yrA"},{"type":"output","id":"liW4IVY5l4LKg7WmOg_6o","data":[],"identifier":"oyjn4wavsz2s-output","visibility":"show","html_id":"oyjn4wavsz2s-output","key":"LkJKyfcAP4"}],"identifier":"oyjn4wavsz2s","label":"oyJN4WaVsz2S","html_id":"oyjn4wavsz2s","visibility":"show","key":"KYfSCMc07w"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Authentification - Get token","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A6bbdama77"}],"identifier":"authentification-get-token","label":"Authentification - Get token","html_id":"authentification-get-token","implicit":true,"key":"gTS8VgHGTY"}],"key":"Ov1BEnii9e"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# By default users should use their DESP credentials to get an Access_token\n# This token is added as an Authorisation Header when interacting with the Hook Service API\n\n# Enter DESP credentials.\nDESP_USERNAME = input(\"Please input your DESP username or email: \")\nDESP_PASSWORD = getpass(\"Please input your DESP password: \")\ntoken = destinelab.AuthHandler(DESP_USERNAME, DESP_PASSWORD)\n\naccess_token = token.get_token()\n\n# Check the status of the request\nif access_token is not None:\n    print(\"DEDL/DESP Access Token Obtained Successfully\")\n    # Save API headers\n    api_headers = {\"Authorization\": \"Bearer \" + access_token}\nelse:\n    print(\"Failed to Obtain DEDL/DESP Access Token\")","visibility":"show","key":"gTptNG3yhe"},{"type":"output","id":"eL7I8qkxmJF35xENG6-Rd","data":[],"visibility":"show","key":"Z4HGkVWi4t"}],"visibility":"show","key":"QYY7QEqTlc"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Setup static variables","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cxYhBqaqSG"}],"identifier":"setup-static-variables","label":"Setup static variables","html_id":"setup-static-variables","implicit":true,"key":"vpZk4R7K68"}],"key":"vz71eLOr6R"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Hook service url (ending with odata/v1/ - e.g. https://odp.data.destination-earth.eu/odata/v1/)\nhook_service_root_url = \"https://odp.data.destination-earth.eu/odata/v1/\"","visibility":"show","key":"EFZ693uFyp"},{"type":"output","id":"4VaJUvvpTs3_i3sSpeszU","data":[],"visibility":"show","key":"HKvh8YwOdo"}],"visibility":"show","key":"S2lsQkRHWy"},{"type":"block","kind":"notebook-content","data":{"id":"OlvgrvV3sz2Y"},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"List available workflows","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z6i9gZVHNS"}],"identifier":"list-available-workflows","label":"List available workflows","html_id":"list-available-workflows","implicit":true,"key":"uTdgziW7ew"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Next we can check what possible workflows are available to us by using method","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qCxnoV8I94"},{"type":"break","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Fa9LHP4Kzs"},{"type":"inlineCode","value":"https://odp.data.destination-earth.eu/odata/v1/Workflows","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"O80ySi5XDy"}],"key":"GZ74XNFjDa"}],"identifier":"olvgrvv3sz2y","label":"OlvgrvV3sz2Y","html_id":"olvgrvv3sz2y","key":"VsxbzlcjiD"},{"type":"block","kind":"notebook-code","data":{"id":"gSxYUs_0sz2Z","tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Send request and return json object listing all provided workfows, ordered by Id\nresult = requests.get(\n    f\"{hook_service_root_url}Workflows?$orderby=Id asc\", headers=api_headers   \n).json()\n\nprint(\"List of available DEDL provided Hooks\")\nfor i in range(len(result[\"value\"])):\n    print(\n        f\"Name:{str(result['value'][i]['Name']).ljust(20, ' ')}DisplayName:{str(result['value'][i]['DisplayName'])}\"\n    )  # print JSON string","identifier":"gsxyus_0sz2z-code","visibility":"show","enumerator":"2","html_id":"gsxyus-0sz2z-code","key":"IqCrFrw112"},{"type":"output","id":"GHs_B8sqc1EKmoMpWflUk","data":[],"identifier":"gsxyus_0sz2z-output","visibility":"show","html_id":"gsxyus-0sz2z-output","key":"JdW52uPCni"}],"identifier":"gsxyus_0sz2z","label":"gSxYUs_0sz2Z","html_id":"gsxyus-0sz2z","visibility":"show","key":"EYAJxaAXk4"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Print result JSON object: containing provided workflow list\nworkflow_details = json.dumps(result, indent=4)\nprint(workflow_details)","visibility":"show","key":"HQyQkzIhk6"},{"type":"output","id":"nZ7qWGWpF_viaVZyolLuf","data":[],"visibility":"show","key":"GPejELXi5T"}],"visibility":"show","key":"oduKhx37r9"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Select a workflow and see parameters","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hDY1dfESHj"}],"identifier":"select-a-workflow-and-see-parameters","label":"Select a workflow and see parameters","html_id":"select-a-workflow-and-see-parameters","implicit":true,"key":"A1G0WqRvPT"}],"visibility":"show","key":"DasseJfYJ7"},{"type":"block","kind":"notebook-content","data":{"id":"jNSqMuRCsz2Z"},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"If we want to see the details of a specific workflow, showing us the parameters that can be set for that workflow, we can add a filter to the query as follows:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aGZWxdtHR7"}],"key":"XihUb5JWNu"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"inlineCode","value":"https://odp.data.destination-earth.eu/odata/v1/Workflows?$expand=WorkflowOptions&$filter=(Name eq data-harvest)","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"D6cmUIpEsj"}],"key":"GimX0qVsNz"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"\\","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"WwAnITh2sf"},{"type":"inlineMath","value":"expand=WorkflowOptions** shows all parameters accepted by workflow   \n**\\\\","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"html":"<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mi>a</mi><mi>n</mi><mi>d</mi><mo>=</mo><mi>W</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>f</mi><mi>l</mi><mi>o</mi><mi>w</mi><mi>O</mi><mi>p</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>s</mi><mo>∗</mo><mo>∗</mo><mi>s</mi><mi>h</mi><mi>o</mi><mi>w</mi><mi>s</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>p</mi><mi>a</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>a</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>p</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>b</mi><mi>y</mi><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>f</mi><mi>l</mi><mi>o</mi><mi>w</mi><mo>∗</mo><mo>∗</mo><mspace linebreak=\"newline\"></mspace></mrow><annotation encoding=\"application/x-tex\">expand=WorkflowOptions** shows all parameters accepted by workflow   \n**\\\\</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">an</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">or</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">wOpt</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord\">∗</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">llp</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">am</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">ers</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">cce</span><span class=\"mord mathnormal\">pt</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">or</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4653em;\"></span><span class=\"mord\">∗</span></span><span class=\"mspace newline\"></span></span></span>","key":"UME2LrIVPo"},{"type":"text","value":"filter=(Name eq data-harvest)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Nqq7pCaKMh"}],"key":"VT26vQeOS1"},{"type":"text","value":" narrows the result to workflow called “data-harvest”","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"GtAUzDjzgF"}],"key":"cYgwgR1hpx"}],"identifier":"jnsqmurcsz2z","label":"jNSqMuRCsz2Z","html_id":"jnsqmurcsz2z","key":"uMb9spBFxg"},{"type":"block","kind":"notebook-code","data":{"id":"UEvKzPclsz2b","tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Select workflow : defaults to data-harvest\nworkflow = os.getenv(\"HOOK_WORKFLOW\", \"data-harvest\")\nprint(f\"workflow: {workflow}\")\n\n# Send request\nresult = requests.get(\n    f\"{hook_service_root_url}Workflows?$expand=WorkflowOptions&$filter=(Name eq '{workflow}')\",\n    headers=api_headers,\n).json()\nworkflow_details = json.dumps(result, indent=4)\nprint(workflow_details)  # print formatted workflow_details, a JSON string","identifier":"uevkzpclsz2b-code","visibility":"show","enumerator":"3","html_id":"uevkzpclsz2b-code","key":"JqbQ8mlD3W"},{"type":"output","id":"65DmGigboixSpcmHFBUJA","data":[],"identifier":"uevkzpclsz2b-output","visibility":"show","html_id":"uevkzpclsz2b-output","key":"Y2Yqziwj4v"}],"identifier":"uevkzpclsz2b","label":"UEvKzPclsz2b","html_id":"uevkzpclsz2b","visibility":"show","key":"Pr7KbSCp6n"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Order selected workflow","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ooc7KOOppf"}],"identifier":"order-selected-workflow","label":"Order selected workflow","html_id":"order-selected-workflow","implicit":true,"key":"It7bOS50qX"}],"key":"Dykjny1Ilv"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The order selected above will now be configured and executed.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KgV2f0B23P"}],"key":"JehkECZOfd"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"e.g. workflow = “data-harvest”.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"T6u8SZmrWS"}],"key":"ELZtEWhhzw"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":5,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Make an order to ‘harvest data’ using Harmonised Data Access API.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Oxfh3IzEXs"}],"key":"PSpMnqIY1a"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"i.e. data from an input source can be transferred to a Private bucket or a Temporary storage bucket.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"zCPg6bw6ly"}],"key":"kGPTTz8aSr"}],"key":"p4gm9zZbll"}],"key":"AsyaVBsVuA"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Name your order","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"K2VYujpfDu"}],"identifier":"name-your-order","label":"Name your order","html_id":"name-your-order","implicit":true,"key":"Gl43DAHMWP"}],"visibility":"show","key":"qXYCZaSNGQ"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Here we set the variable order_name, this will allow us to:\n# Easily identify the running process (e.g. when checking the status)\n# order_name is added as a suffix to the order 'Name'\norder_name = os.getenv(\"HOOK_ORDER_NAME\") or input(\"Name your order: \")\nprint(f\"order_name:{order_name}\")","visibility":"show","key":"lM0doqoHTe"},{"type":"output","id":"t6JiPIVJDilLB1ow7uV7Y","data":[],"visibility":"show","key":"tZZUAOkbez"}],"visibility":"show","key":"h0Dg3M1y5L"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define output storage","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PmRFzQc2fz"}],"identifier":"define-output-storage","label":"Define output storage","html_id":"define-output-storage","implicit":true,"key":"IlUGHrkWnc"}],"key":"HvcoI8OaSD"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"In workflow parameters, among others values, storage to retreive the result has to be provided.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zo6JZBNQ7b"},{"type":"break","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vqTY5xqp27"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Two possibilites:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rErfJLNepd"}],"key":"FexIutZ5Cm"}],"key":"xH9bHwEH6e"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Use your user storage","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"HPTPpUcsPD"}],"key":"Gf8Q2mKv7W"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Use a temporary storage","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Ew7lqHYSzI"}],"key":"BrQBlt7V6v"}],"key":"lKNw5E4acw"}],"key":"qOhMKxzAll"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1. - Your user storage (provided by DEDL ISLET service)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Z9OvJn9mo1"}],"identifier":"id-1-your-user-storage-provided-by-dedl-islet-service","label":"1. - Your user storage (provided by DEDL ISLET service)","html_id":"id-1-your-user-storage-provided-by-dedl-islet-service","implicit":true,"key":"yaHwQMIAZL"}],"visibility":"show","key":"vYRNkHVpZf"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Example using a S3 bucket created with ISLET Storage service  - result will be available in this bucket","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YZlI869sTY"}],"key":"VzR8pHKTa4"},{"type":"blockquote","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"emphasis","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"workflow parameter: {“Name”: “output_storage”, “Value”: “PRIVATE”}","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"QVpSXiopOX"}],"key":"hAS3GXyZCz"}],"key":"tplsVN9OlE"}],"key":"wKwDciBqRX"}],"key":"yj76ob8tv2"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Output storage - Islet service\n\n# Note: If you want the output to go to your own PRIVATE bucket rather than TEMPORARY storage (expires after 2 weeks),\n#       i) This Configuration will need to be updated with your output_bucket, output_storage_access_key, output_secret_key, output_prefix\n#       ii) You will need to change the output_storage in the order to PRIVATE and add the necessary source_ parameters (see workflow options and commented example)\n\n# URL of the S3 endpoint in the Central Site (or lumi etc.)\noutput_storage_url = \"https://s3.central.data.destination-earth.eu\"\n# output_storage_url = \"https://s3.lumi.data.destination-earth.eu\"\n\n# Name of the object storage bucket where the results will be stored.\noutput_bucket = os.getenv(\"HOOK_OUTPUT_BUCKET\", \"your-bucket-name\")\nprint(f\"output_bucket            : {output_bucket}\")\n\n# Islet object storage credentials (openstack ec2 credentials)\noutput_storage_access_key = os.getenv(\"HOOK_OUTPUT_STORAGE_ACCESS_KEY\", \"your-access-key\")\noutput_storage_secret_key = os.getenv(\"HOOK_OUTPUT_STORAGE_SECRET_KEY\", \"your-secret-key\")\nprint(f\"output_storage_access_key: {output_storage_access_key}\")\nprint(f\"output_storage_secret_key: {output_storage_secret_key}\")\n\n\n# This is the name of the folder in your output_bucket where the output of the hook will be stored.\n# Here we concatenate 'dedl' with the 'workflow' and 'order_name'\noutput_prefix = f\"dedl-{workflow}-{order_name}\"\nprint(f\"output_prefix            : {output_prefix}\")","visibility":"show","key":"cf9kAbw4lg"},{"type":"output","id":"cznBKZzdGaSTDekYsvsSO","data":[],"visibility":"show","key":"MnReC145pV"}],"visibility":"show","key":"uUmkzkxl4z"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2 - Use temporary storage","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uqqQ9baAWR"}],"identifier":"id-2-use-temporary-storage","label":"2 - Use temporary storage","html_id":"id-2-use-temporary-storage","implicit":true,"key":"MGuS2EYECR"}],"key":"X3UK2yxLLk"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The result of processing will be stored in shared storage and download link provided in the output product details","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DHNNqwGNqV"}],"key":"Crj3ZYroIY"},{"type":"blockquote","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"emphasis","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"workflow parameter: {“Name”: “output_storage”, “Value”: “TEMPORARY”}","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"eY6zhNy4cj"}],"key":"tMmmO2kzex"}],"key":"yR6MqsfKdA"}],"key":"TuwfCG5RSN"}],"key":"u60wOcKhOf"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define parameters and send order","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FdR7RlNsSJ"}],"identifier":"define-parameters-and-send-order","label":"Define parameters and send order","html_id":"define-parameters-and-send-order","implicit":true,"key":"GfelIRenqj"}],"key":"pWAR7V1uMN"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# URL of the STAC server where your collection/item can be downloaded\nstac_hda_api_url = \"https://hda.data.destination-earth.eu/stac\"\n\n# Note: The data (collection_id and data_id) will have been previously discovered and searched for\n\n# Set collection where the item can be found : defaults to example for data-harvest\ncollection_id = os.getenv(\"HOOK_COLLECTION_ID\", \"EO.ESA.DAT.SENTINEL-2.MSI.L1C\")\nprint(f\"STAC collection url: {stac_hda_api_url}/collections/{collection_id}\")\n\n# Set the Item to Retrieve : defaults to example for data-harvest. If Multiple Values, provide comma separated list\ndata_id = os.getenv(\"HOOK_DATA_ID\", \"S2A_MSIL1C_20230910T050701_N0509_R019_T47VLH_20230910T074321.SAFE\")\nprint(f\"data_id: {data_id}\")\nidentifier_list = [data_id_element.strip() for data_id_element in data_id.split(',')]\n\n# Get boolean value from String, default (False)\nis_private_storage = os.getenv(\"HOOK_IS_PRIVATE_STORAGE\", \"False\") == \"True\"\nprint(f\"is_private_storage: {is_private_storage}\")\n\n# we use source_type to add DESP or EXTERNAL specific configuration\nsource_type = os.getenv(\"HOOK_SOURCE_TYPE\", \"DESP\")\nprint(f\"source_type: {source_type}\")\n\nif source_type == \"EXTERNAL\":\n    EXTERNAL_USERNAME = os.getenv(\"HOOK_EXTERNAL_USERNAME\", \"EXTERNAL_USERNAME\")\n    EXTERNAL_PASSWORD = os.getenv(\"HOOK_EXTERNAL_PASSWORD\", \"EXTERNAL_PASSWORD\")\n    EXTERNAL_TOKEN_URL = os.getenv(\"HOOK_EXTERNAL_TOKEN_URL\", \"EXTERNAL_TOKEN_URL\")\n    EXTERNAL_CLIENT_ID = os.getenv(\"HOOK_EXTERNAL_CLIENT_ID\", \"EXTERNAL_CLIENT_ID\")","visibility":"show","key":"tGByaIjbn7"},{"type":"output","id":"4tiONLrXoGfFrocpRX2hK","data":[],"visibility":"show","key":"s7KaMhvMPB"}],"visibility":"show","key":"gt3XffzSq8"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"########## BUILD ORDER BODY : CHOOSE PRIVATE or TEMPORARY output_storage ##########\n\n# Initialise the order_body\norder_body_custom_bucket = {\n    \"Name\": \"Tutorial \" + workflow + \" - \" + order_name,\n    \"WorkflowName\": workflow,\n    \"IdentifierList\": identifier_list,\n    \"WorkflowOptions\": [],\n}\n\n\n##### Configure PRIVATE OR TEMPORARY STORAGE #####\nif is_private_storage:\n\n    print(\"##### Preparing Order Body for PRIVATE STORAGE #####\")\n    order_body_custom_bucket[\"WorkflowOptions\"].extend(\n        [\n            {\"Name\": \"output_storage\", \"Value\": \"PRIVATE\"},\n            {\"Name\": \"output_s3_access_key\", \"Value\": output_storage_access_key},\n            {\"Name\": \"output_s3_secret_key\", \"Value\": output_storage_secret_key},\n            {\"Name\": \"output_s3_path\", \"Value\": f\"s3://{output_bucket}/{output_prefix}\"},\n            {\"Name\": \"output_s3_endpoint_url\", \"Value\": output_storage_url}\n        ]\n    )\n\nelse:\n\n    print(\"##### Preparing Order Body for TEMPORARY STORAGE #####\")\n    order_body_custom_bucket[\"WorkflowOptions\"].extend(\n        [\n            {\"Name\": \"output_storage\", \"Value\": \"TEMPORARY\"},\n        ]\n    )\n\n##### Configure SOURCE_TYPE and associated parameters #####\nif source_type == \"DESP\":\n\n    # Using DESP credentials is standard way of executing Hooks.\n    print(\"##### Preparing Order Body for access to DEDL HDA using DESP Credentials #####\")\n    order_body_custom_bucket[\"WorkflowOptions\"].extend(\n        [\n            {\"Name\": \"source_type\", \"Value\": \"DESP\"},\n            {\"Name\": \"desp_source_username\", \"Value\": DESP_USERNAME},\n            {\"Name\": \"desp_source_password\", \"Value\": DESP_PASSWORD},\n            {\"Name\": \"desp_source_collection\", \"Value\": collection_id}\n        ]\n    )\n\nelif source_type == \"EXTERNAL\":\n\n    # Build your order body : Example using EXTERNAL source type and source_catalogue_api_type STAC.\n    # This would allow you to access products directly from a configured STAC server\n    # Here we show an example configuration of a STAC server with OIDC security, that could be adapted to your needs (change urls, etc)\n    # This is shown for example purposes only. The standard way of configuring is with DESP source_type seen above.\n    print(\"##### Preparing Order Body for access to EXTERNAL STAC Server using EXTERNAL Credentials #####\")\n    order_body_custom_bucket[\"WorkflowOptions\"].extend(\n        [\n            {\"Name\": \"source_type\", \"Value\": \"EXTERNAL\"},\n            {\"Name\": \"source_catalogue_api_url\", \"Value\": stac_hda_api_url},\n            {\"Name\": \"source_catalogue_api_type\", \"Value\": \"STAC\"},\n            {\"Name\": \"source_token_url\", \"Value\": EXTERNAL_TOKEN_URL},\n            {\"Name\": \"source_grant_type\", \"Value\": \"PASSWORD\"},\n            {\"Name\": \"source_auth_header_name\", \"Value\": \"Authorization\"},\n            {\"Name\": \"source_username\", \"Value\": EXTERNAL_USERNAME},\n            {\"Name\": \"source_password\", \"Value\": EXTERNAL_PASSWORD},\n            {\"Name\": \"source_client_id\", \"Value\": EXTERNAL_CLIENT_ID},\n            {\"Name\": \"source_client_secret\", \"Value\": \"\"},\n            {\"Name\": \"source_catalogue_collection\", \"Value\": collection_id}\n        ]\n    )\n\nelse:\n\n    print(\"source_type not equal to DESP or EXTERNAL\")\n\n\n\n########## ADDITIONAL OPTIONS ##########\n\nadditional_options = []\n\n# Checks environment variables for the form HOOK_ADDITIONAL1=\"NAME=12345;VALUE=abcdef\"\nfor env_key, env_value in os.environ.items():\n    if env_key.startswith('HOOK_ADDITIONAL'):\n        #print(f\"{env_key}: {env_value}\")        \n        parts = env_value.split(';')\n        # Extract the name and value\n        name = parts[0].split('=')[1]\n        value = parts[1].split('=')[1]\n        value_type = parts[2].split('=')[1]\n        additional_options.append({\"Name\": name, \"Value\": value if value_type == 'str' else int(value)})\n\nprint(f\"addditional_options:{additional_options}\")\n\nif additional_options:\n    print(\"Adding additional_options\")\n    order_body_custom_bucket[\"WorkflowOptions\"].extend(additional_options)\n\n########## BUILD ORDER BODY : END ##########\n\n# Uncomment this to see the final order body\n# print(json.dumps(order_body_custom_bucket, indent=4))\n\n\n# Send order\norder_request = requests.post(\n    hook_service_root_url + \"BatchOrder/OData.CSC.Order\",\n    json.dumps(order_body_custom_bucket),\n    headers=api_headers,\n).json()\n\n# If code = 201, the order has been successfully sent\n\n# Print order_request JSON object: containing order_request details\norder_reques_details = json.dumps(order_request, indent=4)\nprint(order_reques_details)\n\norder_id = order_request['value']['Id']\nprint(f\"order 'Id' from order_request: {order_id}\")\n","visibility":"show","key":"djmroaOxsm"},{"type":"output","id":"SDdTJf8iA3fjJqYyPbzey","data":[],"visibility":"show","key":"yZteS2d85L"}],"visibility":"show","key":"VZa7uksdEb"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"It is possible to order multiple product using endpoint:\n","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Q8on3s1yXC"},{"type":"inlineCode","value":"https://odp.data.destination-earth.eu/odata/v1/BatchOrder/OData.CSC.Order","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mBNbnuaRfW"}],"key":"njIE180V5Z"}],"key":"ztn9qy7qoQ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Check The status of the order","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"O15XALTZQE"}],"identifier":"check-the-status-of-the-order","label":"Check The status of the order","html_id":"check-the-status-of-the-order","implicit":true,"key":"wXjpfjCcjp"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Possible status values","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"C0E84DE9Bk"}],"key":"uNKwwLC13v"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"queued (i.e. queued for treatment but not started)","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"naKF1d31Cz"}],"key":"Dpq6NbgbWn"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"in_progress (i.e. order being treated)","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"WdOykegTYd"}],"key":"bPN1fS3vOa"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"completed (i.e. order is complete and data ready)","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"aIu9z7lgkZ"}],"key":"hl3rP1HOHG"}],"key":"Hbv3nd386O"}],"key":"hLtXtK1NMM"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"\n# ProductionOrders endpoint gives status of orders (only with one item attached)\n# Otherwise use BatchOrder(XXXX)/Products endpoint to get status of individual items associated with order\nif len(identifier_list) == 1:\n    order_status_url = f\"{hook_service_root_url}ProductionOrders\"\n    params = {\"$filter\": f\"id eq {order_id}\"}\n    order_status_response = requests.get(order_status_url, params=params, headers=api_headers).json()\n    print(json.dumps(order_status_response, indent=4))\n\n# Get Status of all items of an order in this way\norder_status_response = requests.get(\n    f\"{hook_service_root_url}BatchOrder({order_id})/Products\",\n    headers=api_headers,\n).json()\nprint(json.dumps(order_status_response, indent=4))\n","visibility":"show","key":"MtkGCA9LE8"},{"type":"output","id":"UJbBtoF3sIqJBPPI5d1By","data":[],"visibility":"show","key":"ykz2xbba5i"}],"visibility":"show","key":"iN9tvRK44X"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Access workflow output","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VZ1GCQtWd5"}],"identifier":"access-workflow-output","label":"Access workflow output","html_id":"access-workflow-output","implicit":true,"key":"iuSApobt5X"}],"visibility":"show","key":"OUoR75S1jy"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Private storage","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xs9bL6ycLq"}],"identifier":"private-storage","label":"Private storage","html_id":"private-storage","implicit":true,"key":"FVG0TfCe0l"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Let us now check our private storage using this boto3 script.\nYou can also go and check this in the Islet service using the Horizon user interface","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"cTTjN49y28"}],"key":"Nxr329KpnE"}],"key":"drWg9DbMyw"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# PRIVATE STORAGE: Prints contents of Private Bucket\nimport boto3\n\nif is_private_storage:\n\n    s3 = boto3.client(\n        \"s3\",\n        aws_access_key_id=output_storage_access_key,\n        aws_secret_access_key=output_storage_secret_key,\n        endpoint_url=output_storage_url,\n    )\n\n    paginator = s3.get_paginator(\"list_objects_v2\")\n    pages = paginator.paginate(Bucket=output_bucket, Prefix=output_prefix + \"/\")\n\n    for page in pages:\n        try:\n            for obj in page[\"Contents\"]:\n                print(obj[\"Key\"])\n        except KeyError:\n            print(\"No files exist\")\n            exit(1)","visibility":"show","key":"hA7TXWtD84"},{"type":"output","id":"ptpTucblcLMXhJCOk_Xdt","data":[],"visibility":"show","key":"ibChOHL13P"}],"visibility":"show","key":"TJcRolRTN8"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Temporary storage","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"K3seV3nVyy"}],"identifier":"temporary-storage","label":"Temporary storage","html_id":"temporary-storage","implicit":true,"key":"DTBaDX664T"}],"key":"XDrtGBSIGo"},{"type":"block","kind":"notebook-code","data":{"tags":[]},"children":[{"type":"code","lang":"python","executable":true,"value":"# List order items within a production order\n# When the output_storage is of type TEMPORARY we can get a DownloadLink from the following code (Can also optionally download items here in code with the flag is_download_products)\n\n# If TEMPORARY storage\nif not is_private_storage:\n\n    # Set to True to download products at the same level as the notebook file. File name will be in format \"output-{workflow}-{order_id}-{product_id}.zip\"\n    is_download_products = False\n\n    # Get Status of all items of an order in this way\n    product_status_response = requests.get(\n        f\"{hook_service_root_url}BatchOrder({order_id})/Products\",\n        headers=api_headers,\n    ).json()\n    print(json.dumps(product_status_response, indent=4))\n\n    if is_download_products:\n\n        is_all_products_completed = True\n        # We only attempt to download products when each of the items is in complete status.\n        for i in range(len(product_status_response[\"value\"])):\n\n            product_id = product_status_response[\"value\"][i][\"Id\"]\n            product_status = product_status_response[\"value\"][i][\"Status\"]\n\n            if product_status != \"completed\":\n                is_all_products_completed = False\n\n        # Can download if all products completed\n        if is_all_products_completed:\n\n            for i in range(len(product_status_response[\"value\"])):\n\n                product_id = product_status_response[\"value\"][i][\"Id\"]\n                product_status = product_status_response[\"value\"][i][\"Status\"]\n\n                # Infer the url of the product\n                url_product = f\"{hook_service_root_url}BatchOrder({order_id})/Product({product_id})/$value\"\n                print(f\"url_product: {url_product}\")\n                # Download the product\n                r = requests.get(\n                    url_product, headers=api_headers, allow_redirects=True\n                )\n                product_file_name = f\"output-{workflow}-{order_id}-{product_id}.zip\"\n                open(product_file_name, \"wb\").write(r.content)\n                print(f\"Download Complete: product_file_name: {product_file_name}\")\n\n        else:\n            print(f\"Status for order:{order_id} - At least one of the products does not have the status of 'completed'.\")\n","visibility":"show","key":"NZdU3z6zo4"},{"type":"output","id":"sqzAKWRC8kv0vxj6NOvK4","data":[],"visibility":"show","key":"UR3BI3d0Mn"}],"visibility":"show","key":"QXKEp9RYTC"}],"key":"Xm03NEyHL1"},"references":{"cite":{"order":[],"data":{}}}}